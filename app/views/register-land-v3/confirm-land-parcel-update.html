{% extends "layouts/main.html" %}

{% block pageTitle %}
  DefraMap page template – GOV.UK Prototype Kit
{% endblock %}

{% block head %}
  <link href="/public/stylesheets/application.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/css/index.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block bodyStart %}
  <script>document.body.classList.add('am-is-loading')</script>
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: "javascript:window.history.back()"
  }) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-l">
    <span class="govuk-caption-l">AR FIELDING</span>
      Confirm land parcel 
    </h1>
    <p class="govuk-body">To find a land parcel either use the:</p>
        <ul class="govuk-list govuk-list--bullet">
            <li>+/- icons on the map, or keyboard controls to zoom in and out</li>
            <li>map search to enter a location, for example, the nearest city, town or postcode</li>
        </ul>
  </div>
</div>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div id="map"></div>
  </div>
</div>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div id="parcel-data-container"></div>

{% from "govuk/components/button/macro.njk" import govukButton %}
    <form method="post">

    {{ govukButton({
      text: "Continue"
    }) }}

    </form>

  </div>
</div>
{% endblock %}
  
{% block pageScripts %}
  <!-- Defra library scripts -->
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/providers/maplibre/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/providers/open-names/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/zoom-controls/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/umd/index.js"></script>
  <script src="/public/javascripts/request.js"></script>
  <script src="/public/javascripts/searchCustomDatasets.js"></script>
  
  <script>
  window.env = {
    PARCEL_TILE_SERVICE_URL: '{{ data.PARCEL_TILE_SERVICE_URL | safe }}',
    GRIDREF_SERVICE_URL: '{{ data.GRIDREF_SERVICE_URL | safe }}', 
    PARCEL_SERVICE_URL: '{{ data.PARCEL_SERVICE_URL | safe }}',
    WFS_DATA_URL: '{{ data.WFS_DATA_URL | safe }}',
    WFS_HEDGE_CONTROL_URL: '{{ data.WFS_HEDGE_CONTROL_URL | safe }}',
    WFS_LAND_COVERS_URL: '{{ data.WFS_LAND_COVERS_URL | safe }}'
  }

  // Server-provided data
  const TARGET_SBI = '{{ sbi }}';
  const TARGET_PARCEL_ID = '{{ parcelId }}';
  const PARCEL_PROPERTIES = {{ parcelProperties | dump | safe }};
  
  console.log('Target SBI:', TARGET_SBI);
  console.log('Target Parcel ID:', TARGET_PARCEL_ID);
  console.log('Parcel Properties:', PARCEL_PROPERTIES);

  // Store the target parcel feature globally
  let targetParcelFeature = null;

  function getBounds(geometry) {
    const coords = [];

    function extractCoords(g) {
      if (!g) return;

      switch (g.type) {
        case 'Point':
          coords.push(g.coordinates);
          break;
        case 'MultiPoint':
        case 'LineString':
          g.coordinates.forEach(c => coords.push(c));
          break;
        case 'MultiLineString':
        case 'Polygon':
          g.coordinates.forEach(ring => ring.forEach(c => coords.push(c)));
          break;
        case 'MultiPolygon':
          g.coordinates.forEach(polygon => polygon.forEach(ring => ring.forEach(c => coords.push(c))));
          break;
        case 'GeometryCollection':
          g.geometries.forEach(extractCoords);
          break;
        default:
          throw new Error(`Unsupported geometry type: ${g.type}`);
      }
    }

    extractCoords(geometry);

    const lons = coords.map(c => c[0]);
    const lats = coords.map(c => c[1]);

    return [
      Math.min(...lons),
      Math.min(...lats),
      Math.max(...lons),
      Math.max(...lats)
    ];
  }

  // Fetch parcel geometry from PARCEL_SERVICE_URL
  async function fetchParcelGeometry(parcelId) {
    try {
      const url = `${window.env.PARCEL_SERVICE_URL}/${parcelId}`;
      console.log('Fetching parcel geometry from:', url);
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Parcel geometry data:', data);
      
      // Store as a feature
      targetParcelFeature = {
        type: 'Feature',
        properties: {
          ID: data.properties.ngc,
          SBI: data.properties.sbi,
          AREA_HA: data.properties.area_ha,
          ...data.properties
        },
        geometry: data.geometry
      };
      
      window.targetParcelFeature = targetParcelFeature;
      console.log('Target parcel feature set:', targetParcelFeature);
      
      return targetParcelFeature;
    } catch (error) {
      console.error('Error fetching parcel geometry:', error);
      return null;
    }
  }

  // Create map with parcel data
  async function initializeMap() {
    // Fetch the parcel geometry first
    const parcel = await fetchParcelGeometry(TARGET_PARCEL_ID);
    
    if (!parcel) {
      console.error('Could not load parcel data');
      return;
    }
    
    const bounds = getBounds(parcel.geometry);
    console.log('Parcel bounds:', bounds);
    
    // Create the map
    const defraMap = new defra.DefraMap('map', {
      mapProvider: defra.maplibreProvider(),
      reverseGeocodeProvider: defra.openNamesProvider({
        url: '/api/reverse-geocode-proxy?easting={easting}&northing={northing}'
      }),
      behaviour: 'hybrid',
      minZoom: 6,
      maxZoom: 18,
      bounds,
      containerHeight: '650px',
      transformRequest: transformTileRequest,
      hasExitButton: true,
      mapStyle: {
        url: 'https://tiles.openfreemap.org/styles/liberty',
        attribution: 'OpenFreeMap © OpenMapTiles Data from OpenStreetMap',
        backgroundColor: '#f5f5f0'
      },
      plugins: [
        defra.mapStylesPlugin({
          mapStyles: [{
            id: 'outdoor',
            label: 'Outdoor',
            url: '{{ data.VTS_OUTDOOR_URL }}',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: `Contains OS data ${String.fromCharCode(169)} Crown copyright and database rights ${(new Date()).getFullYear()}`,
            backgroundColor: '#f5f5f0'
          }, {
            id: 'dark',
            label: 'Dark',
            url: '{{ data.VTS_DARK_URL }}',
            mapColorScheme: 'dark',
            appColorScheme: 'dark',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/dark-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo-white.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: 'Test'
          }, {
            id: 'satellite',
            label: 'Satellite',
            url: '/satellite-style.json',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
          }]
        }),
        defra.dataLayersMLPlugin({
          transformRequest: transformDataRequest,
          layers: [
            {
              id: 'field-parcels',
              label: 'Field parcels',
              filter: ['!=', ['get', 'SBI'], TARGET_SBI],
              url: '{{ data.WFS_DATA_URL | safe }}',
              stroke: { outdoor: '#b1b4b6', dark: '#28a197', aerial: 'rgba(40,161,151,0.8)', 'black-and-white': '#28a197' },
              strokeWidth: 2,
              fill: 'transparent',
              minZoom: 15,
              maxZoom: 24
            },
            {
              id: 'linked-parcels',
              label: 'Existing fields',
              filter: ['==', ['get', 'SBI'], TARGET_SBI],
              url: '{{ data.WFS_DATA_URL | safe }}',
              stroke: '#0000ff',
              strokeWidth: 2,
              fill: 'rgba(0,0,255,0.1)',
              minZoom: 15,
              maxZoom: 24
            },
            {
              id: 'selected-parcel',
              label: 'Selected parcel',
              filter: ['==', ['get', 'ID'], TARGET_PARCEL_ID],
              url: '{{ data.WFS_DATA_URL | safe }}',
              stroke: '#ff0000',
              strokeWidth: 3,
              fill: 'rgba(255,0,0,0.2)',
              minZoom: 15,
              maxZoom: 24
            },
            {
              id: 'hedgerows',
              label: 'Hedgerows',
              url: '{{ data.WFS_HEDGE_CONTROL_URL | safe }}',
              stroke: '#228B22',
              strokeWidth: 3,
              fill: 'transparent',
              minZoom: 15,
              maxZoom: 24
            },
            {
              id: 'land-covers',
              label: 'Land covers',
              url: '{{ data.WFS_LAND_COVERS_URL | safe }}',
              stroke: '#666666',
              strokeWidth: 1,
              fill: 'rgba(200,200,200,0.3)',
              minZoom: 15,
              maxZoom: 24
            }
          ]
        }),
        defra.zoomControlsPlugin(),
        defra.scaleBarPlugin({
          units: 'metric'
        })
      ]
    });
    
    // Wait for map to be ready, then fetch and display related data
    defraMap.on('map:ready', () => {
      console.log('Map is ready');
      extractAndDisplayLayerData();
    });

    window.defraMapInstance = defraMap;
  }

  // Function to fetch hedgerow data via API with bbox
  async function fetchHedgerowData(sbi, parcelId, bbox) {
    const wfsBaseUrl = '{{ data.WFS_HEDGE_CONTROL_URL | safe }}';
    
    // Use transformDataRequest exactly as the map does
    const transformed = transformDataRequest({ url: wfsBaseUrl }, bbox);
    
    console.log('Transformed hedgerow URL:', transformed.url);
    
    try {
      const response = await fetch(transformed.url);
      if (!response.ok) {
        console.error('Hedgerow response not OK:', response.status, response.statusText);
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      
      console.log('Hedgerow API returned:', data.features ? data.features.length : 0, 'features');
      
      // Filter for the specific SBI and parcel
      if (data.features && data.features.length > 0) {
        const sbiFiltered = data.features.filter(f => f.properties.SBI == sbi);
        console.log('After SBI filter:', sbiFiltered.length);
        
        const parcelFiltered = sbiFiltered.filter(f => f.properties.REF_PARCEL_ID == parcelId);
        console.log('After parcel filter:', parcelFiltered.length);
        
        const totalLength = parcelFiltered.reduce((sum, f) => sum + (parseFloat(f.properties.LENGTH) || 0), 0);
        return {
          count: parcelFiltered.length,
          totalLength: totalLength.toFixed(2),
          features: parcelFiltered
        };
      }
      return { count: 0, totalLength: '0.00', features: [] };
    } catch (error) {
      console.error('Error fetching hedgerow data:', error);
      return { count: 0, totalLength: '0.00', features: [] };
    }
  }

  // Function to fetch land cover data via API with bbox
  async function fetchLandCoverData(sbi, parcelId, bbox) {
    const wfsBaseUrl = '{{ data.WFS_LAND_COVERS_URL | safe }}';
    
    // Use transformDataRequest exactly as the map does
    const transformed = transformDataRequest({ url: wfsBaseUrl }, bbox);
    
    console.log('Transformed land cover URL:', transformed.url);
    
    try {
      const response = await fetch(transformed.url);
      if (!response.ok) {
        console.error('Land cover response not OK:', response.status, response.statusText);
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      
      console.log('Land cover API returned:', data.features ? data.features.length : 0, 'features');
      
      // Filter for the specific SBI and parcel
      if (data.features && data.features.length > 0) {
        const sbiFiltered = data.features.filter(f => f.properties.SBI == sbi);
        console.log('After SBI filter:', sbiFiltered.length);
        
        const parcelFiltered = sbiFiltered.filter(f => f.properties.REFERENCE_PARCELS_ID == parcelId);
        console.log('After parcel filter:', parcelFiltered.length);
        
        const totalArea = parcelFiltered.reduce((sum, f) => sum + (parseFloat(f.properties.AREA_HA) || 0), 0);
        return {
          count: parcelFiltered.length,
          totalArea: totalArea.toFixed(4),
          features: parcelFiltered
        };
      }
      return { count: 0, totalArea: '0.0000', features: [] };
    } catch (error) {
      console.error('Error fetching land cover data:', error);
      return { count: 0, totalArea: '0.0000', features: [] };
    }
  }

  // Function to fetch and display data using API with bbox
  async function extractAndDisplayLayerData() {
    if (!targetParcelFeature) {
      console.log('Parcel not ready yet');
      return;
    }
    
    const parcelID = targetParcelFeature.properties.ID;
    const bounds = getBounds(targetParcelFeature.geometry);
    const bbox = bounds.join(',');
    
    console.log('Fetching hedgerow and land cover data with bbox:', bbox);
    
    // Fetch the data
    const hedgerowData = await fetchHedgerowData(TARGET_SBI, parcelID, bbox);
    const landCoverData = await fetchLandCoverData(TARGET_SBI, parcelID, bbox);
    
    console.log('Hedgerow data:', hedgerowData);
    console.log('Land cover data:', landCoverData);
    
    // Build hedgerow HTML
    let hedgerowHTML = 'None';
    if (hedgerowData.count > 0) {
      hedgerowHTML = `${hedgerowData.count} (${hedgerowData.totalLength}m total)`;
    }
    
    // Build land cover HTML
    let landCoverHTML = 'None';
    if (landCoverData.features.length > 0) {
      const coverItems = landCoverData.features.map(feature => {
        const description = feature.properties.DESCRIPTION || 'Unknown';
        const area = feature.properties.AREA_HA ? parseFloat(feature.properties.AREA_HA).toFixed(4) : 'N/A';
        return `${description}: ${area} ha`;
      });
      landCoverHTML = coverItems.join('<br>');
    }
    
    // Update the display
    const container = document.getElementById('parcel-data-container');
    if (container && targetParcelFeature) {
      const props = targetParcelFeature.properties;
      
      container.innerHTML = `
        <h2 class="govuk-heading-m govuk-!-margin-top-6">Land parcel</h2>
        
        <table class="govuk-table">
          <tbody class="govuk-table__body">
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header" style="width: 25%">ID</th>
              <td class="govuk-table__cell">${TARGET_PARCEL_ID}</td>
            </tr>
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Description</th>
              <td class="govuk-table__cell">${PARCEL_PROPERTIES.description || 'N/A'}</td>
            </tr>
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Hedgerows</th>
              <td class="govuk-table__cell">${hedgerowHTML}</td>
            </tr>
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Land covers</th>
              <td class="govuk-table__cell">${landCoverHTML}</td>
            </tr>
          </tbody>
        </table>
      `;
    }
  }

  // Initialize the map when page loads
  initializeMap();
</script>
{% endblock %}
