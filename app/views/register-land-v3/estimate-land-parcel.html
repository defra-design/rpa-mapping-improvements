{% extends "layouts/main.html" %}

{% block pageTitle %}
  Find the land you want to register – GOV.UK Prototype Kit
{% endblock %}

{% block head %}
  <link href="/public/stylesheets/application.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/css/index.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block bodyStart %}
  <script>document.body.classList.add('am-is-loading')</script>
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: "javascript:window.history.back()"
  }) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-l">
      <span class="govuk-caption-l">AR FIELDING</span>
      Find the land you want to register 
    </h1>
    <p class="govuk-body">To find a land parcel either use the:</p>
    <ul class="govuk-list govuk-list--bullet">
      <li>+/- icons on the map, or keyboard controls to zoom in and out</li>
      <li>map search to enter a location, for example, the nearest city, town or postcode</li>
      <li>click on a parcel to select it and view its details</li>
    </ul>
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div id="map" data-zoom="15" data-center="[-2.968, 54.425]"></div>
    
    <br>
    
    <div id="parcel-data-container"></div>

    <form method="post">
      <input id="coords" name="coords" type="hidden"/>
      {{ govukButton({
        id: "continue-btn",
        text: "Continue",
        disabled: true
      }) }}
    </form>
  </div>
</div>
{% endblock %}
  
{% block pageScripts %}
<!-- Defra library scripts -->
<script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/providers/maplibre/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/providers/open-names/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/zoom-controls/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/umd/index.js"></script>
<script src="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/umd/index.js"></script>
<script src="/public/javascripts/request.js"></script>
<script src="/public/javascripts/searchCustomDatasets.js"></script>

<script>
  console.log('Script initializing...');

  window.env = {
    WFS_SERVICE_URL: '{{ data.WFS_SERVICE_URL | safe }}',
    GRIDREF_SERVICE_URL: '{{ data.GRIDREF_SERVICE_URL | safe }}', 
    PARCEL_SERVICE_URL: '{{ data.PARCEL_SERVICE_URL | safe }}'
  }

  // Store all fetched parcel data globally
  let allParcelData = [];

  // Set up fetch interception to capture parcel data
  (function setupFetchInterception() {
    const originalFetch = window.fetch;
    let dataFetched = false;
    
    window.fetch = function(...args) {
      const url = args[0];
      
      if (typeof url === 'string' && url.includes('LandParcels') && !dataFetched) {
        console.log('Intercepted parcel data request');
        
        return originalFetch.apply(this, args).then(response => {
          return response.clone().json().then(data => {
            
            if (data.features && data.features.length > 0) {
              dataFetched = true;
              allParcelData = data.features;
              console.log('Stored parcels:', allParcelData.length);
              
              // Display list of visible parcels
              displayParcelList();
            }
            
            return response;
          });
        });
      }
      
      return originalFetch.apply(this, args);
    };
  })();

  // Create the interact plugin instance
  const interactPlugin = defra.interactPlugin({
    dataLayers: [],
    // dataLayers: [{
    //   layerId: 'field-parcels',
    //   idProperty: 'ID',
    //   selectedFeatureStyle: { 
    //     stroke: { outdoor: '#ff0000', dark: '#00ff00' }, 
    //     strokeWidth: 3, 
    //     fill: 'rgba(255, 0, 0, 0.2)' 
    //   }
    // }],
    markerColor: { outdoor: '#ff0000', dark: '#00ff00' },
    interactionMode: 'marker',
  });

  // Create the map
  const defraMap = new defra.DefraMap('map', {
    mapProvider: defra.maplibreProvider(),
    reverseGeocodeProvider: defra.openNamesProvider({
      url: '/api/reverse-geocode-proxy?easting={easting}&northing={northing}'
    }),
    behaviour: 'inline',
    minZoom: 6,
    maxZoom: 18,
    containerHeight: '650px',
    transformRequest: transformTileRequest,
    mapStyle: {
      url: 'https://tiles.openfreemap.org/styles/liberty',
      attribution: 'OpenFreeMap © OpenMapTiles Data from OpenStreetMap',
      backgroundColor: '#f5f5f0'
    },
    plugins: [
      defra.mapStylesPlugin({
        mapStyles: [{
          id: 'outdoor',
          label: 'Outdoor',
          url: '{{ data.VTS_OUTDOOR_URL }}',
          thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
          logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
          logoAltText: 'Ordnance survey logo',
          attribution: `Contains OS data ${String.fromCharCode(169)} Crown copyright and database rights ${(new Date()).getFullYear()}`,
          backgroundColor: '#f5f5f0'
        }, {
          id: 'dark',
          label: 'Dark',
          url: '{{ data.VTS_DARK_URL }}',
          mapColorScheme: 'dark',
          appColorScheme: 'dark',
          thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/dark-map-thumb.jpg',
          logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo-white.svg',
          logoAltText: 'Ordnance survey logo',
          attribution: 'Test'
        }, {
          id: 'black-and-white',
          label: 'Black/White',
          url: '{{ data.VTS_BLACK_AND_WHITE_URL }}',
          thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/black-and-white-map-thumb.jpg',
          logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo-black.svg',
          logoAltText: 'Ordnance survey logo',
          attribution: 'Test'
        }, {
          id: 'satellite',
          label: 'Satellite',
          url: '/satellite-style.json',
          thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
          logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
          logoAltText: 'Ordnance survey logo',
          attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
        }]
      }),
      interactPlugin,
      defra.searchPlugin({
        osNamesURL: '/api/geocode-proxy?query={query}',
        customDatasets: searchCustomDatasets,
        width: '300px',
        showMarker: false,
        isExpanded: true
      }),
      defra.zoomControlsPlugin(),
      defra.scaleBarPlugin({
        units: 'metric'
      })
    ]
  });

  defraMap.on('interact:markerchange', (e) => {
    const coords = document.querySelector('#coords')
    coords.value = JSON.stringify(e.coords)
    const continueButton = document.querySelector('#continue-btn')
    continueButton.removeAttribute('aria-disabled')
    continueButton.removeAttribute('disabled')
  })

  // Function to display list of visible parcels
  function displayParcelList() {
    const container = document.getElementById('parcel-data-container');
    
    if (!container) {
      console.error('Could not find parcel-data-container element');
      return;
    }
    
    const totalArea = allParcelData.reduce((sum, parcel) => {
      return sum + (parseFloat(parcel.properties.AREA_HA) || 0);
    }, 0);
    
    // Sort parcels by ID for easier reading
    const sortedParcels = [...allParcelData].sort((a, b) => {
      const aRef = `${a.properties.SHEET_ID || ''} ${a.properties.PARCEL_ID || ''}`.trim();
      const bRef = `${b.properties.SHEET_ID || ''} ${b.properties.PARCEL_ID || ''}`.trim();
      return aRef.localeCompare(bRef);
    });
    
    container.innerHTML = `
      <h2 class="govuk-heading-m">Visible land parcels</h2>
      
      <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Total parcels in view</dt>
          <dd class="govuk-summary-list__value">${allParcelData.length}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Total area</dt>
          <dd class="govuk-summary-list__value">${totalArea.toFixed(2)} ha</dd>
        </div>
      </dl>
      
      <details class="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">
            View all parcel IDs
          </span>
        </summary>
        <div class="govuk-details__text">
          <table class="govuk-table">
            <thead class="govuk-table__head">
              <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header">Parcel ID</th>
                <th scope="col" class="govuk-table__header">Area (ha)</th>
                <th scope="col" class="govuk-table__header">SBI</th>
              </tr>
            </thead>
            <tbody class="govuk-table__body">
              ${sortedParcels.map(parcel => {
                const sheetId = parcel.properties.SHEET_ID || '';
                const parcelId = parcel.properties.PARCEL_ID || '';
                const combinedRef = (sheetId && parcelId) ? `${sheetId} ${parcelId}` : 'N/A';
                const area = parcel.properties.AREA_HA ? parseFloat(parcel.properties.AREA_HA).toFixed(4) : 'N/A';
                const sbi = parcel.properties.SBI || 'N/A';
                
                return `
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell">${combinedRef}</td>
                    <td class="govuk-table__cell">${area}</td>
                    <td class="govuk-table__cell">${sbi}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      </details>
    `;
  }

  console.log('Map initialization complete');
</script>
{% endblock %}
