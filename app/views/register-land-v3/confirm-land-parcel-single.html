{% extends "layouts/main.html" %}

{% block pageTitle %}
  DefraMap page template – GOV.UK Prototype Kit
{% endblock %}

{% block head %}
  <link href="/public/stylesheets/application.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/css/index.css" rel="stylesheet" type="text/css">
  <link href="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/css/index.css" rel="stylesheet" type="text/css">
{% endblock %}

{% block bodyStart %}
  <script>document.body.classList.add('am-is-loading')</script>
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back",
    href: "javascript:window.history.back()"
  }) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-l">
    <span class="govuk-caption-l">AR FIELDING</span>
      Confirm land parcel 
    </h1>
    <p class="govuk-body">To find a land parcel either use the:</p>
        <ul class="govuk-list govuk-list--bullet">
            <li>+/- icons on the map, or keyboard controls to zoom in and out</li>
            <li>map search to enter a location, for example, the nearest city, town or postcode</li>
        </ul>
  </div>
</div>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter">
    <!-- <h2 class="govuk-heading-m">Land parcel</h2>
    <p>Parcel ID</p>
    <p>Approximate area (ha)</p>
    <p>Location</p> -->

  <div id="parcel-data-container"></div>

{% from "govuk/components/button/macro.njk" import govukButton %}
    <form method="post">

    {{ govukButton({
      text: "Save and continue"
    }) }}

    </form>

  </div>
  <div class="govuk-grid-column-three-quarters">
    <p>{{ data.VALUE }}</p>
    <div id="map"></div>
  </div>
</div>
<!-- <div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <p>{{ data | dump }}</p>

    <p>{{ data.VALUE }}</p>
    <div id="map" data-zoom="15" data-center="[-2.968, 54.425]"></div>

    <br>

    <div id="parcel-data-container"></div>

    <form method="post">

    {{ govukButton({
      text: "Continue"
    }) }}

    </form>

  </div>
</div> -->
{% endblock %}
  
  {% block pageScripts %}
  <!-- Defra library scripts -->
  <script src="/plugin-assets/%40defra%2Fdefra-map/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/providers/maplibre/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/providers/open-names/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/map-styles/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/search/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/zoom-controls/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/scale-bar/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/data-layers-ml/dist/umd/index.js"></script>
  <script src="/plugin-assets/%40defra%2Fdefra-map/plugins/interact/dist/umd/index.js"></script>
  <script src="/public/javascripts/request.js"></script>
  <script src="/public/javascripts/searchCustomDatasets.js"></script>
  
  <script>
  console.log('Script block is running!');
  console.log('WFS_DATA_URL:', '{{ data.WFS_DATA_URL | safe }}');

  window.env = {
    WFS_SERVICE_URL: '{{ data.WFS_SERVICE_URL | safe }}',
    GRIDREF_SERVICE_URL: '{{ data.GRIDREF_SERVICE_URL | safe }}', 
    PARCEL_SERVICE_URL: '{{ data.PARCEL_SERVICE_URL | safe }}'
  }

  // The SBI and Parcel ID we want to display
  const TARGET_SBI = '106332870';
  const TARGET_PARCEL_ID = '{{ data["parcel-id"] }}'; // From the text input on previous page

  console.log('TARGET_PARCEL_ID:', TARGET_PARCEL_ID);

    // Store the target parcel feature globally so we can access it later
    let targetParcelFeature = null;

    function getBounds(geometry) {
    const coords = [];

    function extractCoords(g) {
      if (!g) return;

      switch (g.type) {
        case 'Point':
          coords.push(g.coordinates);
          break;
        case 'MultiPoint':
        case 'LineString':
          g.coordinates.forEach(c => coords.push(c));
          break;
        case 'MultiLineString':
        case 'Polygon':
          g.coordinates.forEach(ring => ring.forEach(c => coords.push(c)));
          break;
        case 'MultiPolygon':
          g.coordinates.forEach(polygon => polygon.forEach(ring => ring.forEach(c => coords.push(c))));
          break;
        case 'GeometryCollection':
          g.geometries.forEach(extractCoords);
          break;
        default:
          throw new Error(`Unsupported geometry type: ${g.type}`);
      }
    }

    extractCoords(geometry);

    const lons = coords.map(c => c[0]);
    const lats = coords.map(c => c[1]);

    return [
      Math.min(...lons),
      Math.min(...lats),
      Math.max(...lons),
      Math.max(...lats)
    ];
  }

  // Function to calculate center from parcel features
  function calculateCenter(features) {
    let totalLng = 0, totalLat = 0, count = 0;
    
    features.forEach(feature => {
      if (feature.geometry && feature.geometry.coordinates) {
        const coords = feature.geometry.type === 'Polygon' 
          ? feature.geometry.coordinates[0] 
          : feature.geometry.coordinates;
        
        coords.forEach(coord => {
          totalLng += coord[0];
          totalLat += coord[1];
          count++;
        });
      }
    });
    
    return count > 0 ? [totalLng / count, totalLat / count] : null;
  }

  // Function to parse parcel ID (handles "NY3703 8152" or "NY37038152" formats)
  function parseParcelID(parcelId) {
    // Remove any spaces
    const cleaned = parcelId.replace(/\s+/g, '');
    
    // Try to extract sheet ID (letters + first digits) and parcel ID (remaining digits)
    const match = cleaned.match(/^([A-Z]{2}\d{4})(\d+)$/i);
    
    if (match) {
      return {
        sheetId: match[1].toUpperCase(),
        parcelId: match[2]
      };
    }
    


    return null;
  }

  // Function to fetch parcels for a specific SBI and find one by parcel ID
  // Function to fetch parcels for a specific SBI and find one by parcel ID
function fetchSpecificParcel(sbi, parcelId) {
  console.log('Fetching parcel for SBI:', sbi, 'Parcel ID:', parcelId);
  
  const parsed = parseParcelID(parcelId);
  if (!parsed) {
    console.error('Could not parse parcel ID:', parcelId);
    return Promise.resolve(null);
  }
  
  console.log('Parsed parcel:', parsed);
  
  // Fetch ALL parcels for this SBI (without parcel ID filter)
  const wfsUrl = `{{ data.WFS_DATA_URL | safe }}`;
  const wfsWithFilter = `${wfsUrl}&CQL_FILTER=SBI='${sbi}'&outputFormat=application/json&srsName=EPSG:4326`;
  
  // Detect environment and use correct proxy
//   const proxyBase = window.location.hostname === 'localhost' 
//     ? 'http://localhost:8000'
//     : 'https://farming-data-7db3d1889632.herokuapp.com';

    // Always use Heroku proxy
    const proxyBase = 'https://farming-data-7db3d1889632.herokuapp.com';
  
  const proxyUrl = `${proxyBase}/wfs_geojson?wfs_url=${encodeURIComponent(wfsWithFilter)}`;
  
  console.log('Fetching all parcels for SBI from proxy:', proxyUrl);
  
  return fetch(proxyUrl)
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Fetched all parcels for SBI:', data);
      
      // Filter client-side to find the specific parcel
      if (data.features && data.features.length > 0) {
        const matchingParcel = data.features.find(feature => 
          feature.properties.SHEET_ID === parsed.sheetId && 
          feature.properties.PARCEL_ID === parsed.parcelId
        );
        
        if (matchingParcel) {
          console.log('Found matching parcel:', matchingParcel);
          // Store globally
          targetParcelFeature = matchingParcel;
          window.targetParcelFeature = targetParcelFeature;
          
          // Return a FeatureCollection with just this parcel
          return {
            type: 'FeatureCollection',
            features: [matchingParcel]
          };
        } else {
          console.log('No matching parcel found for SHEET_ID:', parsed.sheetId, 'PARCEL_ID:', parsed.parcelId);
          return null;
        }
      }
      
      return null;
    })
    .catch(error => {
      console.error('Error fetching parcel:', error);
      return null;
    });
}

  // Fetch the specific parcel and create the map
  if (TARGET_PARCEL_ID && TARGET_PARCEL_ID.trim() !== '') {
    fetchSpecificParcel(TARGET_SBI, TARGET_PARCEL_ID).then(data => {
      let mapCenter = [-2.968, 54.425]; // Default center
      let mapZoom = 15; // Set to 15
      
      if (data && data.features && data.features.length > 0) {
        console.log(`Found parcel for SBI ${TARGET_SBI}, Parcel ID ${TARGET_PARCEL_ID}`);
        const center = calculateCenter(data.features);
        
        if (center) {
          mapCenter = center;
          console.log('Calculated center:', mapCenter);
        }
        
        // Display the target parcel data immediately
        displayTargetParcelData();
      } else {
        console.log(`Parcel not found for SBI ${TARGET_SBI}, Parcel ID ${TARGET_PARCEL_ID}, using default center`);
      }
      
      // Update the map div with the calculated center
      const mapDiv = document.getElementById('map');
      // mapDiv.setAttribute('data-center', `[${mapCenter[0]}, ${mapCenter[1]}]`);
      // mapDiv.setAttribute('data-zoom', mapZoom.toString());
      
      // Now create the map
      createMap();
    });
  } else {
    console.log('No parcel ID provided');
    // Create map at default location
    createMap();
  }

  // Set up fetch interception (but we won't use it for display anymore)
  let dataDisplayed = false;
  const originalFetch = window.fetch;
  
  window.fetch = function(...args) {
    const url = args[0];
    console.log('Fetch called with URL:', url);
    
    if (typeof url === 'string' && url.includes('LandParcels') && !dataDisplayed) {
      console.log('Intercepted parcel data request:', url);
      dataDisplayed = true;
    }
    
    return originalFetch.apply(this, args);
  };
  
  console.log('Fetch interception set up');

  // Function to create the map
  function createMap() {
    console.log(window.targetParcelFeature)


    const bounds = getBounds(window.targetParcelFeature.geometry)


    const interactPlugin = defra.interactPlugin({
      dataLayers: [{
        layerId: 'field-parcels',
        idProperty: 'ID',
        selectedFeatureStyle: { stroke: { outdoor: '#ff0000', dark: '#00ff00' }, strokeWidth: 2, fill: 'rgba(255, 0, 0, 0.1)' }
      },{
        layerId: 'linked-parcels',
        idProperty: 'ID',
        selectedFeatureStyle: { stroke: { outdoor: '#ff0000', dark: '#00ff00' }, strokeWidth: 2, fill: 'rgba(255, 0, 0, 0.1)' }
      }],
      markerColor: { outdoor: '#ff0000', dark: '#00ff00' },
      interactionMode: 'select',
      multiSelect: true
    })
        
    const defraMap = new defra.DefraMap('map', {
      mapProvider: defra.maplibreProvider(),
      reverseGeocodeProvider: defra.openNamesProvider({
        url: '/api/reverse-geocode-proxy?easting={easting}&northing={northing}'
      }),
      behaviour: 'hybrid',
      mapLabel: 'Ambleside',
      minZoom: 6,
      maxZoom: 18,
      bounds,
      containerHeight: '650px',
      transformRequest: transformTileRequest,
      mapStyle: {
        url: 'https://tiles.openfreemap.org/styles/liberty',
        attribution: 'OpenFreeMap © OpenMapTiles Data from OpenStreetMap',
        backgroundColor: '#f5f5f0'
      },
      plugins: [
        defra.mapStylesPlugin({
          mapStyles: [{
            id: 'outdoor',
            label: 'Outdoor',
            url: '{{ data.VTS_OUTDOOR_URL }}',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: `Contains OS data ${String.fromCharCode(169)} Crown copyright and database rights ${(new Date()).getFullYear()}`,
            backgroundColor: '#f5f5f0'
          }, {
            id: 'dark',
            label: 'Dark',
            url: '{{ data.VTS_DARK_URL }}',
            mapColorScheme: 'dark',
            appColorScheme: 'dark',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/dark-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo-white.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: 'Test'
          }, {
            id: 'black-and-white',
            label: 'Black/White',
            url: '{{ data.VTS_BLACK_AND_WHITE_URL }}',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/black-and-white-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo-black.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: 'Test'
          }, {
            id: 'satellite',
            label: 'Satellite',
            url: '/satellite-style.json',
            thumbnail: '/plugin-assets/%40defra%2Fdefra-map/assets/images/outdoor-map-thumb.jpg',
            logo: '/plugin-assets/%40defra%2Fdefra-map/assets/images/os-logo.svg',
            logoAltText: 'Ordnance survey logo',
            attribution: 'Esri, Maxar, Earthstar Geographics, and the GIS User Community'
          }]
        }),
        defra.dataLayersMLPlugin({
          transformRequest: transformDataRequest,
          layers: [{
            id: 'field-parcels',
            label: 'Field parcels',
            filter: ['!=', ['get', 'SBI'], TARGET_SBI],
            url: '{{ data.WFS_DATA_URL | safe }}',
            stroke: { outdoor: '#b1b4b6', dark: '#28a197', aerial: 'rgba(40,161,151,0.8)', 'black-and-white': '#28a197' },
            strokeWidth: 2,
            fill: 'transparent',
            minZoom: 15,
            maxZoom: 24
          },{
            id: 'linked-parcels',
            label: 'Existing fields',
            filter: ['==', ['get', 'SBI'], TARGET_SBI],
            url: '{{ data.WFS_DATA_URL | safe }}',
            stroke: '#0000ff',
            strokeWidth: 2,
            fill: 'rgba(0,0,255,0.1)',
            minZoom: 15,
            maxZoom: 24
          }]
        }),
        interactPlugin,
        // defra.searchPlugin({
        //   osNamesURL: '/api/geocode-proxy?query={query}',
        //   customDatasets: searchCustomDatasets,
        //   width: '300px',
        //   showMarker: false
        // }),
        defra.zoomControlsPlugin(),
        defra.scaleBarPlugin({
          units: 'metric'
        })
      ]
    });
    
    defraMap.on('map:ready', () => {

      document.querySelector('.dm-o-app__actions').style.display = 'none'
      interactPlugin.selectFeature({
        idProperty: 'ID',
        featureId: window.targetParcelFeature.properties.ID,
        layerId: 'linked-parcels'
      })
    })

    defraMap.on('interact:selectionchange', (e) => {
      console.log(e)
    })
    // Store defraMap globally for future reference
    window.defraMapInstance = defraMap;
  }

  // Function to display the target parcel data
  function displayTargetParcelData() {
    const container = document.getElementById('parcel-data-container');
    console.log('Container element:', container);
    
    if (!container) {
      console.error('Could not find parcel-data-container element');
      return;
    }
    
    if (!targetParcelFeature) {
      container.innerHTML = '<p class="govuk-body">No parcel data available.</p>';
      return;
    }
    
    const props = targetParcelFeature.properties;
    const sheetId = props.SHEET_ID || 'N/A';
    const parcelId = props.PARCEL_ID || 'N/A';
    const combinedRef = sheetId !== 'N/A' && parcelId !== 'N/A' ? `${sheetId} ${parcelId}` : 'N/A';
    
    container.innerHTML = `
          <h2 class="govuk-heading-m govuk-!-margin-top-3">Land parcel</h2>
          
          <table class="govuk-table">
            <tbody class="govuk-table__body">
              <tr class="govuk-table__row">
                <th scope="row" class="govuk-table__header">ID</th>
                <td class="govuk-table__cell">${combinedRef}</td>
              </tr>
              <tr class="govuk-table__row">
                <th scope="row" class="govuk-table__header">Area (ha)</th>
                <td class="govuk-table__cell">${props.AREA_HA ? parseFloat(props.AREA_HA).toFixed(4) : 'N/A'}</td>
              </tr>
              <tr class="govuk-table__row">
                <th scope="row" class="govuk-table__header">Location</th>
                <td class="govuk-table__cell">TBC</td>
              </tr>
            </tbody>
          </table>
    `;
  }
</script>
{% endblock %}
