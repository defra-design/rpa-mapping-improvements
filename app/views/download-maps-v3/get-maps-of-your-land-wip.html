{% extends "layouts/main.html" %}

{% from "govuk/components/service-navigation/macro.njk" import govukServiceNavigation %}

{% block header %}
  {{ govukHeader() }}
{{ govukServiceNavigation({
  serviceName: "Land and farm",
  serviceUrl: "#",
  navigation: [
    {
      href: "#",
      text: "Get maps of your land",
      active: true
    },
    {
      href: "#",
      text: "Register land"
    },
    {
      href: "#",
      text: "Transfer land"
    }
  ]
}) }}
{% endblock %}

{% set excludeBeforeContent = true %}

{% block head %}
  {{ super() }}
  <link href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css" rel="stylesheet">
{% endblock %}

{% block pageTitle %}
  Map - Get maps of your land – {{ serviceName }} – GOV.UK Prototype Kit
{% endblock %}

{% block content %}
  <div style="display: flex; gap: 20px; max-width: 100%; padding: 0;">
    <!-- Left sidebar -->
    <div style="width: 230px; flex-shrink: 0;">
      {% from "govuk/components/radios/macro.njk" import govukRadios %}

      {{ govukRadios({
        formGroup: {
        classes: "govuk-!-static-margin-bottom-0"
        },
        classes: "govuk-radios--small",
        name: "changedName",
        fieldset: {
          legend: {
            text: "Maps",
            isPageHeading: true,
            classes: "govuk-fieldset__legend--s govuk-!-static-margin-bottom-1"
          }
        },
        items: [
          {
            value: "whole-holding",
            text: "Whole holding",
            checked: true
          },
          {
            value: "indi-parcels",
            text: "Individual land parcels"
          }
        ]
      }) }}

      {% from "govuk/components/button/macro.njk" import govukButton %}

      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-static-margin-top-2 govuk-!-static-margin-bottom-2">
      
      <div id="land-parcels-section">
        {% from "govuk/components/input/macro.njk" import govukInput %}
        {{ govukInput({
          id: "parcel-filter",
          name: "parcelFilter",
          classes: "govuk-input--width-10",
          formGroup: {
            classes: "govuk-!-margin-bottom-2"
          },
          label: {
            text: "Filter",
            classes: "govuk-label--s"
          }
        }) }}
        
        <div class="scrollable-checkbox-container" id="parcels-list">
          <p class="govuk-body-s">Loading parcels...</p>
        </div>
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible  govuk-!-static-margin-top-2 govuk-!-static-margin-bottom-2">
      </div>

      <div>
        <h2 class="govuk-heading-s govuk-!-static-margin-bottom-1">Data</h2>
        
        <div class="scrollable-checkbox-container">
          {% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}

          {{ govukCheckboxes({
            formGroup: {
            classes: "govuk-!-static-margin-bottom-0"
            },
            name: "additionalInfo",
            classes: "govuk-checkboxes--small",
            items: [
              {
                value: "land-covers",
                text: "Land covers"
              },
              {
                value: "hedgerows",
                text: "Hedgerows"
              }
            ]
          }) }}
        </div>    
      </div>
      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible  govuk-!-static-margin-top-2 govuk-!-static-margin-bottom-2">
    </div>

    <!-- Map area -->
    <div style="flex: 1; position: relative;">
      <div id="map" style="width: 100%; height: 800px;"></div>
      
      <!-- Whole holding overlay -->
      <div id="whole-holding-overlay" class="map-overlay">
        <button class="map-overlay-close" aria-label="Hide panel">Hide</button>
        <h2 class="govuk-heading-s govuk-!-margin-bottom-2">Whole holding</h2>
        <dl class="govuk-summary-list govuk-summary-list--no-border govuk-!-margin-bottom-3">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Total area (ha)</dt>
            <dd class="govuk-summary-list__value" id="total-area">Loading...</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Total parcels</dt>
            <dd class="govuk-summary-list__value" id="total-parcels">Loading...</dd>
          </div>
        </dl>
        
        {{ govukButton({
          text: "Download map"
        }) }}
      </div>
      
      <!-- Individual parcels overlay -->
      <div id="individual-parcels-overlay" class="map-overlay" style="display: none;">
        <button class="map-overlay-close" aria-label="Hide panel">Hide</button>
        
        <!-- Search input in overlay -->
        <form class="map-search-form" id="location-search-form">
          <label class="govuk-label govuk-label--s govuk-!-margin-bottom-1" for="location-search">
            Search
          </label>
          <div class="map-search-wrapper-inline">
            <input 
              class="govuk-input map-search-input-inline govuk-input--width-10" 
              id="location-search" 
              name="location-search" 
              type="text"
              autocomplete="off"
              placeholder="">
          </div>
        </form>
        
        <!-- Search results dropdown -->
        <div id="search-results" class="map-search-results-inline" style="display: none;">
          <ul class="map-search-results-list" id="search-results-list">
            <!-- Results will be populated here -->
          </ul>
        </div>
        
        <dl class="govuk-summary-list govuk-summary-list--no-border govuk-!-margin-bottom-3 govuk-!-margin-top-3">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Selected area (ha)</dt>
            <dd class="govuk-summary-list__value" id="selected-area">0</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Parcels selected</dt>
            <dd class="govuk-summary-list__value" id="selected-count">0 of 0</dd>
          </div>
        </dl>
        
        {{ govukButton({
          text: "Download map"
        }) }}
      </div>
    </div>
  </div>
{% endblock %}

{% block pageScripts %}
<script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuration
    const SBI = '106332870'; // Your test SBI
    let landParcelsData = null;
    let landCoversData = null;
    let hedgeControlData = null;
    let parcelLayers = {};

    // Initialize the map
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        'version': 8,
        'sources': {
          'raster-tiles': {
            'type': 'raster',
            'tiles': [
              'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
            ],
            'tileSize': 256,
            'attribution': '© OpenStreetMap contributors'
          }
        },
        'layers': [
          {
            'id': 'simple-tiles',
            'type': 'raster',
            'source': 'raster-tiles',
            'minzoom': 0,
            'maxzoom': 22
          }
        ]
      },
      center: [-2, 54], // Center of UK
      zoom: 5 // Zoomed out to see whole UK initially
    });

    // Search marker
    let searchMarker = null;

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Add scale control
    map.addControl(new maplibregl.ScaleControl({
      maxWidth: 100,
      unit: 'metric'
    }), 'bottom-left');

    // Fetch land parcels from RPA API
    async function fetchLandParcels() {
      try {
        // Request data in EPSG:4326 (WGS84 lat/lng) which Maplibre uses natively
        const url = `https://environment.data.gov.uk/data-services/RPA/LandParcels/wfs?version=2.0.0&request=GetFeature&typeNames=RPA:LandParcels&cql_filter=SBI=${SBI}&srsname=EPSG:4326&outputFormat=application/json`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        landParcelsData = data;
        
        console.log('Loaded parcels:', data);
        console.log('First feature coordinates:', data.features[0]?.geometry.coordinates);
        
        return data;
      } catch (error) {
        console.error('Error fetching land parcels:', error);
        document.getElementById('parcels-list').innerHTML = 
          '<p class="govuk-body-s" style="color: #d4351c;">Error loading parcels. Please check console.</p>';
        return null;
      }
    }

    // Fetch land covers from RPA API
    async function fetchLandCovers() {
      try {
        const url = `https://environment.data.gov.uk/data-services/RPA/LandCovers/wfs?version=2.0.0&request=GetFeature&typeNames=RPA:LandCovers&cql_filter=SBI=${SBI}&srsname=EPSG:4326&outputFormat=application/json`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        landCoversData = data;
        
        console.log('Loaded land covers:', data);
        
        return data;
      } catch (error) {
        console.error('Error fetching land covers:', error);
        return null;
      }
    }

    // Fetch hedge control from RPA API
    async function fetchHedgeControl() {
      try {
        const url = `https://environment.data.gov.uk/data-services/RPA/HedgeControl/wfs?version=2.0.0&request=GetFeature&typeNames=RPA:HedgeControl&cql_filter=SBI=${SBI}&srsname=EPSG:4326&outputFormat=application/json`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        hedgeControlData = data;
        
        console.log('Loaded hedge control:', data);
        
        return data;
      } catch (error) {
        console.error('Error fetching hedge control:', error);
        return null;
      }
    }

    // Add parcels to map
    function addParcelsToMap(data) {
      if (!data || !data.features || data.features.length === 0) {
        console.log('No parcel features found');
        return;
      }

      // Add source for all parcels
      map.addSource('land-parcels', {
        type: 'geojson',
        data: data
      });

      // Add fill layer for parcels
      map.addLayer({
        id: 'parcels-fill',
        type: 'fill',
        source: 'land-parcels',
        paint: {
          'fill-color': '#1d70b8', // GOV.UK blue
          'fill-opacity': 0.3
        }
      });

      // Add outline layer for parcels
      map.addLayer({
        id: 'parcels-outline',
        type: 'line',
        source: 'land-parcels',
        paint: {
          'line-color': '#1d70b8',
          'line-width': 2
        }
      });

      // Add highlight layer (initially empty) - SOURCE FIRST
      map.addSource('selected-parcels', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: []
        }
      });

        // THEN add the layers with explicit visibility
        map.addLayer({
        id: 'selected-parcels-fill',
        type: 'fill',
        source: 'selected-parcels',
        paint: {
            'fill-color': '#ffdd00', // GOV.UK yellow
            'fill-opacity': 0.5
        },
        layout: {
            'visibility': 'visible'
        }
        });

        map.addLayer({
        id: 'selected-parcels-outline',
        type: 'line',
        source: 'selected-parcels',
        paint: {
            'line-color': '#0b0c0c', // GOV.UK black
            'line-width': 3
        },
        layout: {
            'visibility': 'visible'
        }
        });

      // Move selected layers to the top after a brief delay
      setTimeout(() => {
        if (map.getLayer('selected-parcels-fill')) {
          map.moveLayer('selected-parcels-fill');
        }
        if (map.getLayer('selected-parcels-outline')) {
          map.moveLayer('selected-parcels-outline');
        }
      }, 100);

      // Fit map to parcels bounds
      const bounds = new maplibregl.LngLatBounds();
      data.features.forEach(feature => {
        if (feature.geometry.type === 'Polygon') {
          feature.geometry.coordinates[0].forEach(coord => {
            bounds.extend(coord);
          });
        } else if (feature.geometry.type === 'MultiPolygon') {
          feature.geometry.coordinates.forEach(polygon => {
            polygon[0].forEach(coord => {
              bounds.extend(coord);
            });
          });
        }
      });

      map.fitBounds(bounds, { padding: 50 });

// Store the handler function so we can remove it later
if (!map._parcelClickHandler) {
  let isProcessingClick = false;
  
  map._parcelClickHandler = (e) => {
    // If already processing a click, ignore this one completely
    if (isProcessingClick) {
      console.log('Click ignored - already processing another click');
      return;
    }
    
    isProcessingClick = true;
    
    // Reset the flag after 100ms
    setTimeout(() => {
      isProcessingClick = false;
    }, 100);
    
    console.log('=== PARCEL CLICK EVENT ===');
    console.log('Parcel clicked:', e.features[0]?.properties);
    
    // Check if land covers or hedge control layers are visible
    const landCoversVisible = map.getLayer('land-covers-fill') && 
                             map.getLayoutProperty('land-covers-fill', 'visibility') === 'visible';
    const hedgeControlVisible = map.getLayer('hedge-control-line') && 
                                map.getLayoutProperty('hedge-control-line', 'visibility') === 'visible';
    
    // If data layers are visible, check if we actually clicked on them
    if (landCoversVisible || hedgeControlVisible) {
      const landCoverFeatures = map.queryRenderedFeatures(e.point, {
        layers: ['land-covers-fill']
      });
      const hedgeFeatures = map.queryRenderedFeatures(e.point, {
        layers: ['hedge-control-line']
      });
      
      // Only block parcel interaction if we actually clicked on a data layer feature
      if (landCoverFeatures.length > 0 || hedgeFeatures.length > 0) {
        return;
      }
    }
    
    if (e.features.length > 0) {
      const feature = e.features[0];
      const props = feature.properties;
      
      // Get the full feature from landParcelsData
      const fullFeature = landParcelsData.features.find(f => 
        f.properties.SHEET_ID === props.SHEET_ID && 
        f.properties.PARCEL_ID === props.PARCEL_ID
      );
      
      if (fullFeature) {
        // Check if selected-parcels source exists
        const selectedSource = map.getSource('selected-parcels');
        if (!selectedSource) {
          console.error('selected-parcels source not found');
          return;
        }
        
        // Get current selected parcels
        const currentData = selectedSource._data;
        const currentFeatures = currentData.features || [];
        
        // Check if this parcel is already selected
        const parcelId = `${props.SHEET_ID}${props.PARCEL_ID}`;
        const existingIndex = currentFeatures.findIndex(f => 
          `${f.properties.SHEET_ID}${f.properties.PARCEL_ID}` === parcelId
        );
        
        let newFeatures;
        if (existingIndex !== -1) {
          // Parcel already selected - remove it (toggle off)
          newFeatures = currentFeatures.filter((f, i) => i !== existingIndex);
        } else {
          // Parcel not selected - add it
          newFeatures = [...currentFeatures, fullFeature];
        }
        
        // Update the selected parcels
        console.log('About to update selected parcels, new count:', newFeatures.length);
        console.log('Selected source exists:', !!selectedSource);
        selectedSource.setData({
          type: 'FeatureCollection',
          features: newFeatures
        });
        console.log('Selected parcels data updated successfully');
        
        // Update statistics in the overlay
        const totalArea = newFeatures.reduce((sum, f) => 
          sum + parseFloat(f.properties.AREA_HA || 0), 0
        );
        document.getElementById('selected-area').textContent = totalArea.toFixed(4);
        document.getElementById('selected-count').textContent = 
          `${newFeatures.length} of ${landParcelsData.features.length}`;
        
        // Also update checkboxes to match
        const checkbox = document.getElementById(`parcel-${parcelId}`);
        if (checkbox) {
          checkbox.checked = existingIndex === -1; // Check if we just added it
        }
      }
      
      // Show popup
      new maplibregl.Popup()
        .setLngLat(e.lngLat)
        .setHTML(`
          <strong>Land parcel</strong><br>
          ${props.SHEET_ID} ${props.PARCEL_ID}<br>
          Total area (ha) ${parseFloat(props.AREA_HA).toFixed(4)}
        `)
        .addTo(map);
    }
  };
}

// Remove any existing handler first
map.off('click', 'parcels-fill', map._parcelClickHandler);

// Add the handler
map.on('click', 'parcels-fill', map._parcelClickHandler);
      

      // Change cursor on hover
      map.on('mouseenter', 'parcels-fill', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'parcels-fill', () => {
        map.getCanvas().style.cursor = '';
      });
    }

    // Add land covers to map
    function addLandCoversToMap(data) {
    if (!data || !data.features || data.features.length === 0) {
        console.log('No land cover features found');
        return;
    }

    // Add source for land covers
    map.addSource('land-covers', {
        type: 'geojson',
        data: data
    });

    // Add fill layer for land covers
    map.addLayer({
        id: 'land-covers-fill',
        type: 'fill',
        source: 'land-covers',
        paint: {
        'fill-color': '#00703c', // GOV.UK green
        'fill-opacity': 0.3
        },
        layout: {
        'visibility': 'none' // Hidden by default
        }
    });

    // Add outline layer for land covers
    map.addLayer({
        id: 'land-covers-outline',
        type: 'line',
        source: 'land-covers',
        paint: {
        'line-color': '#00703c',
        'line-width': 1
        },
        layout: {
        'visibility': 'none' // Hidden by default
        }
    });

    // Store the handler function so we can remove it later
    if (!map._landCoverClickHandler) {
        map._landCoverClickHandler = (e) => {
        // Check if we clicked on a hedge - if so, don't show land cover popup
        const hedgeFeatures = map.queryRenderedFeatures(e.point, {
            layers: ['hedge-control-line']
        });
        
        if (hedgeFeatures.length > 0) {
            return; // Let the hedge handler take precedence
        }
        
        if (e.features.length > 0) {
            const props = e.features[0].properties;
            
            new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <strong>Land cover</strong><br>
                ${props.DESCRIPTION || 'N/A'}<br>
                Land parcel ${props.SHEET_ID || ''} ${props.PARCEL_ID || ''}<br>
                Total area (ha) ${parseFloat(props.AREA_HA || 0).toFixed(4)}<br>
                Code ${props.LAND_COVER_CLASS_CODE || 'N/A'}
            `)
            .addTo(map);
        }
        };
    }

    // Remove any existing handlers first
    map.off('click', 'land-covers-fill', map._landCoverClickHandler);
    map.off('mouseenter', 'land-covers-fill');
    map.off('mouseleave', 'land-covers-fill');

    // Add the handlers
    map.on('click', 'land-covers-fill', map._landCoverClickHandler);

    // Change cursor on hover
    map.on('mouseenter', 'land-covers-fill', () => {
        map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', 'land-covers-fill', () => {
        map.getCanvas().style.cursor = '';
    });
    }
    

    // Add hedge control to map
// Add hedge control to map
function addHedgeControlToMap(data) {
  if (!data || !data.features || data.features.length === 0) {
    console.log('No hedge control features found');
    return;
  }

  // Add source for hedge control
  map.addSource('hedge-control', {
    type: 'geojson',
    data: data
  });

  // Add line layer for hedges
  map.addLayer({
    id: 'hedge-control-line',
    type: 'line',
    source: 'hedge-control',
    paint: {
      'line-color': '#912b88', // GOV.UK purple
      'line-width': 3
    },
    layout: {
      'visibility': 'none' // Hidden by default
    }
  });

  // Store the handler function so we can remove it later
  if (!map._hedgeClickHandler) {
    map._hedgeClickHandler = (e) => {
      // Stop the event from propagating to layers below
      e.preventDefault();
      
      if (e.features.length > 0) {
        const props = e.features[0].properties;
        
        new maplibregl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <strong>Hedgerow</strong><br>
            Length (m): ${parseFloat(props.LENGTH || 0).toFixed(2)}<br>
            Land parcel: ${props.REF_PARCEL_SHEET_ID || ''} ${props.REF_PARCEL_PARCEL_ID || ''}
          `)
          .addTo(map);
      }
    };
  }

  // Remove any existing handlers first
  map.off('click', 'hedge-control-line', map._hedgeClickHandler);
  map.off('mouseenter', 'hedge-control-line');
  map.off('mouseleave', 'hedge-control-line');

  // Add the handlers
  map.on('click', 'hedge-control-line', map._hedgeClickHandler);

  // Change cursor on hover
  map.on('mouseenter', 'hedge-control-line', () => {
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', 'hedge-control-line', () => {
    map.getCanvas().style.cursor = '';
  });
}

    // Clear highlights when clicking on the map background (not on a parcel)
    map.on('click', (e) => {
      const features = map.queryRenderedFeatures(e.point, {
        layers: ['parcels-fill']
      });
      
      const selectedValue = document.querySelector('input[name="changedName"]:checked')?.value;
      
      // If no parcel was clicked and we're in "whole holding" mode, clear everything
      if (features.length === 0 && selectedValue === 'whole-holding') {
        const selectedSource = map.getSource('selected-parcels');
        if (selectedSource) {
          selectedSource.setData({
            type: 'FeatureCollection',
            features: []
          });
        }
      }
      
      // In individual parcels mode, clicking background doesn't clear selections
    });

    // Create parcel checkboxes
    function createParcelCheckboxes(data) {
      if (!data || !data.features || data.features.length === 0) {
        document.getElementById('parcels-list').innerHTML = 
          '<p class="govuk-body-s">No parcels found for this SBI.</p>';
        return;
      }

      const parcels = data.features.map(f => ({
        id: `${f.properties.SHEET_ID}${f.properties.PARCEL_ID}`,
        sheetId: f.properties.SHEET_ID,
        parcelId: f.properties.PARCEL_ID,
        area: f.properties.AREA_HA,
        feature: f
      }));

      // Sort parcels by ID
      parcels.sort((a, b) => a.id.localeCompare(b.id));

      // Calculate totals
      const totalArea = parcels.reduce((sum, p) => sum + parseFloat(p.area || 0), 0);
      document.getElementById('total-area').textContent = totalArea.toFixed(4);
      document.getElementById('total-parcels').textContent = parcels.length;
      document.getElementById('selected-count').textContent = `0 of ${parcels.length}`;

      // Create checkboxes HTML
      let checkboxesHTML = '<div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">';
      
      parcels.forEach(parcel => {
        checkboxesHTML += `
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input parcel-checkbox" 
                   id="parcel-${parcel.id}" 
                   name="landParcels" 
                   type="checkbox" 
                   value="${parcel.id}"
                   data-area="${parcel.area}">
            <label class="govuk-label govuk-checkboxes__label" for="parcel-${parcel.id}">
              ${parcel.sheetId} ${parcel.parcelId}
            </label>
            <div class="govuk-hint govuk-checkboxes__hint">
              Total area (ha) ${parseFloat(parcel.area).toFixed(4)}
            </div>
          </div>
        `;
      });
      
      checkboxesHTML += '</div>';
      
      document.getElementById('parcels-list').innerHTML = checkboxesHTML;

      // Add event listeners to checkboxes
      document.querySelectorAll('.parcel-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedParcels);
      });
    }

    // Update selected parcels on map
    function updateSelectedParcels() {
      const selectedCheckboxes = document.querySelectorAll('.parcel-checkbox:checked');
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
      
      // Filter features for selected parcels
      const selectedFeatures = landParcelsData.features.filter(f => {
        const id = `${f.properties.SHEET_ID}${f.properties.PARCEL_ID}`;
        return selectedIds.includes(id);
      });

      // Update selected parcels source
      const selectedSource = map.getSource('selected-parcels');
      if (selectedSource) {
        selectedSource.setData({
          type: 'FeatureCollection',
          features: selectedFeatures
        });

        // Calculate selected area
        const selectedArea = Array.from(selectedCheckboxes)
          .reduce((sum, cb) => sum + parseFloat(cb.dataset.area || 0), 0);
        
        document.getElementById('selected-area').textContent = selectedArea.toFixed(4);
        document.getElementById('selected-count').textContent = 
          `${selectedCheckboxes.length} of ${landParcelsData.features.length}`;
      }
    }

    // Setup additional layers checkboxes
    function setupAdditionalLayersCheckboxes() {
      const checkboxes = document.querySelectorAll('input[name="additionalInfo"]');
      
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const value = e.target.value;
          const visibility = e.target.checked ? 'visible' : 'none';
          
          if (value === 'land-covers') {
            if (map.getLayer('land-covers-fill')) {
              map.setLayoutProperty('land-covers-fill', 'visibility', visibility);
              map.setLayoutProperty('land-covers-outline', 'visibility', visibility);
            }
          } else if (value === 'hedgerows') {
            if (map.getLayer('hedge-control-line')) {
              map.setLayoutProperty('hedge-control-line', 'visibility', visibility);
            }
          }
        });
      });
    }

    // Location search functionality
    const searchForm = document.getElementById('location-search-form');
    const searchInput = document.getElementById('location-search');
    const searchResults = document.getElementById('search-results');
    const searchResultsList = document.getElementById('search-results-list');

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function simplifyDisplayName(displayName) {
      let parts = displayName.split(',').map(part => part.trim());
      const unwantedTerms = ['England', 'United Kingdom', 'UK'];
      
      parts = parts.filter((part, index) => {
        if (unwantedTerms.some(term => part === term)) {
          return false;
        }
        if (index === parts.length - 2 && parts[parts.length - 1] === 'England') {
          return false;
        }
        if (index === parts.length - 3 && parts[parts.length - 1] === 'United Kingdom') {
          return false;
        }
        return true;
      });
      
      return parts.slice(0, 3).join(', ');
    }

    // Search parcels by ID
    function searchParcels(query) {
      if (!landParcelsData || !landParcelsData.features) {
        return [];
      }

      const searchTerm = query.toLowerCase().replace(/\s+/g, '');
      
      return landParcelsData.features.filter(feature => {
        const parcelId = `${feature.properties.SHEET_ID}${feature.properties.PARCEL_ID}`.toLowerCase();
        const parcelIdWithSpace = `${feature.properties.SHEET_ID} ${feature.properties.PARCEL_ID}`.toLowerCase();
        return parcelId.includes(searchTerm) || parcelIdWithSpace.includes(query.toLowerCase());
      }).map(feature => ({
        type: 'parcel',
        feature: feature,
        displayName: `${feature.properties.SHEET_ID} ${feature.properties.PARCEL_ID}`,
        area: feature.properties.AREA_HA
      }));
    }

    async function searchLocation(query) {
      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }

      // First, search for matching parcels
      const parcelResults = searchParcels(query);
      
      // Then search for locations
      let locationResults = [];
      if (query.length >= 3) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=3&countrycodes=gb`
          );
          locationResults = await response.json();
          locationResults = locationResults.map(result => ({
            type: 'location',
            data: result,
            displayName: simplifyDisplayName(result.display_name)
          }));
        } catch (error) {
          console.error('Search error:', error);
        }
      }

      // Combine results (parcels first)
      const allResults = [...parcelResults, ...locationResults];

      if (allResults.length > 0) {
        displaySearchResults(allResults);
      } else {
        searchResults.style.display = 'none';
      }
    }

    function displaySearchResults(results) {
      searchResultsList.innerHTML = '';
      
      results.forEach(result => {
        const li = document.createElement('li');
        li.className = 'map-search-results-item';
        
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'map-search-results-button';
        
        if (result.type === 'parcel') {
          button.innerHTML = `
            <strong>${result.displayName}</strong><br>
            <span style="font-size: 14px; color: #505a5f;">Total area (ha) ${parseFloat(result.area).toFixed(4)}</span>
          `;
          button.addEventListener('click', () => {
            selectParcel(result.feature);
          });
        } else {
          button.textContent = result.displayName;
          button.addEventListener('click', () => {
            selectLocation(result.data);
          });
        }
        
        li.appendChild(button);
        searchResultsList.appendChild(li);
      });
      
      searchResults.style.display = 'block';
    }

    function selectParcel(feature) {
      // Calculate bounds of the parcel
      const bounds = new maplibregl.LngLatBounds();
      
      if (feature.geometry.type === 'Polygon') {
        feature.geometry.coordinates[0].forEach(coord => {
          bounds.extend(coord);
        });
      } else if (feature.geometry.type === 'MultiPolygon') {
        feature.geometry.coordinates.forEach(polygon => {
          polygon[0].forEach(coord => {
            bounds.extend(coord);
          });
        });
      }

      // Fit map to parcel bounds with padding
      map.fitBounds(bounds, { 
        padding: 100,
        duration: 2000
      });

      // Update search input
      searchInput.value = `${feature.properties.SHEET_ID} ${feature.properties.PARCEL_ID}`;
      searchResults.style.display = 'none';

      // Highlight the parcel
      const selectedSource = map.getSource('selected-parcels');
      if (selectedSource) {
        selectedSource.setData({
          type: 'FeatureCollection',
          features: [feature]
        });
      }

      // Show popup
      const center = bounds.getCenter();
      new maplibregl.Popup()
        .setLngLat(center)
        .setHTML(`
          <strong>Land parcel</strong><br>
          ${feature.properties.SHEET_ID} ${feature.properties.PARCEL_ID}<br>
          Total area (ha): ${parseFloat(feature.properties.AREA_HA).toFixed(4)}
        `)
        .addTo(map);
    }

    function selectLocation(result) {
      const lat = parseFloat(result.lat);
      const lon = parseFloat(result.lon);
      
      map.flyTo({
        center: [lon, lat],
        zoom: 15,
        duration: 2000
      });

      if (searchMarker) {
        searchMarker.remove();
      }

      searchMarker = new maplibregl.Marker({
        color: '#1d70b8'
      })
        .setLngLat([lon, lat])
        .addTo(map);

      searchInput.value = simplifyDisplayName(result.display_name);
      searchResults.style.display = 'none';
    }

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const firstResult = searchResultsList.querySelector('.map-search-results-button');
      if (firstResult && searchResults.style.display !== 'none') {
        firstResult.click();
      }
    });

    const debouncedSearch = debounce((query) => {
      searchLocation(query);
    }, 300);

    searchInput.addEventListener('input', (e) => {
      debouncedSearch(e.target.value.trim());
    });

    document.addEventListener('click', (e) => {
      if (!searchForm.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Radio button functionality
    const radios = document.querySelectorAll('input[name="changedName"]');
    const landParcelsSection = document.getElementById('land-parcels-section');
    const wholeHoldingOverlay = document.getElementById('whole-holding-overlay');
    const individualParcelsOverlay = document.getElementById('individual-parcels-overlay');
    const closeButtons = document.querySelectorAll('.map-overlay-close');
    const filterInput = document.getElementById('parcel-filter');
    
    function toggleContent() {
      const selectedValue = document.querySelector('input[name="changedName"]:checked')?.value;
      
      if (selectedValue === 'indi-parcels') {
        landParcelsSection.style.display = 'block';
        wholeHoldingOverlay.style.display = 'none';
        individualParcelsOverlay.style.display = 'block';
      } else {
        landParcelsSection.style.display = 'none';
        wholeHoldingOverlay.style.display = 'block';
        individualParcelsOverlay.style.display = 'none';
      }
    }
    
    function filterParcels() {
      const filterValue = filterInput.value.toLowerCase();
      const parcelItems = document.querySelectorAll('#parcels-list .govuk-checkboxes__item');
      
      parcelItems.forEach(item => {
        const label = item.querySelector('.govuk-checkboxes__label');
        const labelText = label ? label.textContent.toLowerCase() : '';
        
        if (labelText.includes(filterValue)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    radios.forEach(radio => {
      radio.addEventListener('change', toggleContent);
    });
    
    closeButtons.forEach(button => {
    button.addEventListener('click', function() {
        const overlay = this.parentElement;
        
        if (overlay.classList.contains('map-overlay-collapsed')) {
        // Expand the overlay
        overlay.classList.remove('map-overlay-collapsed');
        this.textContent = 'Hide';
        this.setAttribute('aria-label', 'Hide panel');
        } else {
        // Collapse the overlay
        overlay.classList.add('map-overlay-collapsed');
        this.textContent = 'Show';
        this.setAttribute('aria-label', 'Show panel');
        }
        
        // Remove focus after click
        this.blur();
    });
    });
    
    if (filterInput) {
      filterInput.addEventListener('input', filterParcels);
    }
    
    toggleContent();

    // Load parcels when map is ready - THIS MUST BE LAST
    map.on('load', function() {
    // Create and add style toggle button with icon
    const styleToggle = document.createElement('button');
    styleToggle.id = 'style-toggle';
    styleToggle.className = 'map-style-toggle';
    styleToggle.setAttribute('aria-label', 'Switch to satellite view');
    styleToggle.setAttribute('title', 'Switch to satellite view'); // Tooltip on hover

    // Add icon as background image
    styleToggle.innerHTML = '<img src="/public/images/map.svg" alt="" aria-hidden="true">';

    // Add to map container
    document.getElementById('map').appendChild(styleToggle);
      
      let currentStyle = 'streets';
      
      styleToggle.addEventListener('click', () => {
  if (currentStyle === 'streets') {
    // Switch to satellite
    map.setStyle({
      'version': 8,
      'sources': {
        'satellite-tiles': {
          'type': 'raster',
          'tiles': [
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
          ],
          'tileSize': 256,
          'attribution': '© Esri, Maxar, Earthstar Geographics'
        }
      },
      'layers': [
        {
          'id': 'satellite',
          'type': 'raster',
          'source': 'satellite-tiles',
          'minzoom': 0,
          'maxzoom': 22
        }
      ]
    });
    currentStyle = 'satellite';
    styleToggle.setAttribute('aria-label', 'Switch to map view');
    styleToggle.setAttribute('title', 'Switch to map view');
  } else {  
    // Switch to streets
    map.setStyle({
      'version': 8,
      'sources': {
        'raster-tiles': {
          'type': 'raster',
          'tiles': [
            'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
          ],
          'tileSize': 256,
          'attribution': '© OpenStreetMap contributors'
        }
      },
      'layers': [
        {
          'id': 'simple-tiles',
          'type': 'raster',
          'source': 'raster-tiles',
          'minzoom': 0,
          'maxzoom': 22
        }
      ]
    });
    currentStyle = 'streets';
    styleToggle.setAttribute('aria-label', 'Switch to satellite view');
    styleToggle.setAttribute('title', 'Switch to satellite view');
  }
  
  // Remove focus after click
  styleToggle.blur();
  
  // Re-add your data layers after style change
  map.once('styledata', () => {
    // setStyle() already removes all layers and sources, so we just re-add
    if (landParcelsData) {
      addParcelsToMap(landParcelsData);
    }
    if (landCoversData) {
      addLandCoversToMap(landCoversData);
    }
    if (hedgeControlData) {
      addHedgeControlToMap(hedgeControlData);
    }
    
    // Re-setup checkbox listeners
    setupAdditionalLayersCheckboxes();
    
    // Restore the current selection state
    updateSelectedParcels();
    
    // Restore visibility of land covers and hedgerows based on checkbox state
    const landCoversCheckbox = document.querySelector('input[name="additionalInfo"][value="land-covers"]');
    const hedgerowsCheckbox = document.querySelector('input[name="additionalInfo"][value="hedgerows"]');
    
    if (landCoversCheckbox && landCoversCheckbox.checked) {
      if (map.getLayer('land-covers-fill')) {
        map.setLayoutProperty('land-covers-fill', 'visibility', 'visible');
        map.setLayoutProperty('land-covers-outline', 'visibility', 'visible');
      }
    }
    
    if (hedgerowsCheckbox && hedgerowsCheckbox.checked) {
      if (map.getLayer('hedge-control-line')) {
        map.setLayoutProperty('hedge-control-line', 'visibility', 'visible');
      }
    }
  });
});

      // Fetch all data
      (async () => {
        const parcelsData = await fetchLandParcels();
        const coversData = await fetchLandCovers();
        const hedgesData = await fetchHedgeControl();
        
        if (parcelsData) {
          addParcelsToMap(parcelsData);
          createParcelCheckboxes(parcelsData);
        }
        
        if (coversData) {
          addLandCoversToMap(coversData);
        }
        
        if (hedgesData) {
          addHedgeControlToMap(hedgesData);
        }
        
        // Set up checkbox listeners for additional layers
        setupAdditionalLayersCheckboxes();
      })();
    });
  });
</script>

<style>
  .scrollable-checkbox-container {
    max-height: 325px;
    overflow-y: auto;
    overflow-x: visible;
    margin-left: -15px;
    padding-left: 15px;
    padding-right: 10px;
    margin-bottom: 30px;
  }
  
  .scrollable-checkbox-container .govuk-checkboxes__label {
    font-size: 1rem;
    line-height: 1.25;
  }
  
  .scrollable-checkbox-container .govuk-checkboxes__hint {
    font-size: 1rem;
    line-height: 1.25;
    padding-right: 0px;
    margin-top: -14px;
  }
  
  .govuk-radios__label {
    font-size: 1rem;
    line-height: 1.25;
  }
  
  .scrollable-checkbox-container::-webkit-scrollbar {
    width: 8px;
  }
  
  .scrollable-checkbox-container::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  .scrollable-checkbox-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 0px;
  }
  
  .scrollable-checkbox-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Map search styles - inline in overlay */
  .map-search-form {
    margin-bottom: 0;
  }

  .map-search-wrapper-inline {
    margin-bottom: 10px;
  }

  .map-search-input-inline {
    font-size: 1rem;
    line-height: 1.25;
  }

  .map-search-input-inline:focus {
    outline: 3px solid #ffdd00;
    outline-offset: 0;
    box-shadow: none;
    border-color: #0b0c0c;
  }

  .map-search-input-inline::placeholder {
    font-size: 1rem;
    line-height: 1.25;
  }

  .map-search-results-inline {
    background-color: white;
    border: 2px solid #0b0c0c;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 15px;
    margin-top: -10px;
    max-width: 11.24em;
  }

  .map-search-results-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .map-search-results-item {
    border-bottom: 1px solid #b1b4b6;
  }

  .map-search-results-item:last-child {
    border-bottom: none;
  }

  .map-search-results-button {
    width: 100%;
    padding: 10px 15px;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-family: "GDS Transport", arial, sans-serif;
    font-size: 1rem;
    line-height: 1.25;
    color: #0b0c0c;
  }

  .map-search-results-button strong {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.25;
  }

  .map-search-results-button:hover {
    background-color: #f3f2f1;
  }

  .map-search-results-button:focus {
    outline: 3px solid #ffdd00;
    outline-offset: 0;
    background-color: #ffdd00;
    color: #0b0c0c;
  }

  /* Map overlay styles */
  .map-overlay {
    position: absolute;
    top: 5px;
    left: 6px;
    background-color: white;
    padding: 10px;
    padding-top: 15px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    max-width: 275px;
    z-index: 10;
  }

  .map-overlay .govuk-summary-list {
    font-size: 1rem;
    line-height: 1.25;
  }

  .map-overlay .govuk-summary-list__key,
  .map-overlay .govuk-summary-list__value {
    padding: 5px 0;
    width: 50%;
    font-size: 1rem;
    line-height: 1.25;
  }
  
    .map-overlay-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border: 2px solid #0b0c0c;
    color: #0b0c0c;
    padding: 5px 10px;
    font-size: 1rem; /* Changed from 14px to match map toggle */
    line-height: 1.25;
    font-weight: 700;
    cursor: pointer;
    font-family: "GDS Transport", arial, sans-serif;
    min-width: 60px;
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    }

  .map-overlay-close:hover {
    background-color: #f3f2f1;
  }

  .map-overlay-close:focus {
    outline: none !important;
    box-shadow: none !important;
  }

  .map-overlay-close:focus-visible {
    outline: 3px solid #ffdd00 !important;
    outline-offset: 0;
    box-shadow: inset 0 0 0 4px #0b0c0c !important;
  }

  .govuk-button {
    font-size: 1rem;
    line-height: 1.25;
    margin-bottom: 3px;
  }
  
  .govuk-checkboxes__hint {
    margin-top: -14px;
  }
  
  #parcel-filter {
    font-size: 1rem;
    line-height: 1.25;
    text-transform: uppercase;
  }

  /* Maplibre popup styles */
  .maplibregl-popup {
    pointer-events: none !important;
  }

  .maplibregl-popup-content {
    padding: 15px 20px;
    font-size: 1rem;
    line-height: 1.25;
    min-width: 200px;
    font-family: "GDS Transport", arial, sans-serif;
    pointer-events: auto !important;
  }

  .maplibregl-popup-tip {
    pointer-events: auto !important;
  }

  .maplibregl-popup-content:focus {
    outline: none !important;
  }

  .maplibregl-popup-content strong {
    font-size: 1.1875rem;
    line-height: 1.25;
    display: block;
    margin-bottom: 2px;
    font-weight: 700;
  }

  .maplibregl-popup-close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 34px;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0b0c0c;
    font-family: "GDS Transport", arial, sans-serif;
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 10 !important;
    background: none !important;
    border: none !important;
  }

  .maplibregl-popup-close-button:hover {
    background-color: #f3f2f1 !important;
  }

  .maplibregl-popup-close-button:focus {
    outline: none !important;
    background-color: transparent !important;
  }

  .maplibregl-popup-close-button:focus-visible {
    outline: 3px solid #ffdd00 !important;
    outline-offset: 0;
    background-color: #ffdd00 !important;
  }

/* Collapsed overlay state */
.map-overlay-collapsed {
  width: auto;
  height: auto;
  padding: 0; /* Changed from 5px to 0 */
  overflow: visible;
  max-width: none;
}

  .map-overlay-collapsed * {
    display: none;
  }

  .map-overlay-collapsed .map-overlay-close {
    display: flex !important;
    position: static;
    margin: 0;
  }

/* Map style toggle button */
.map-style-toggle {
  position: absolute;
  top: 125px; /* Position below navigation controls (adjust as needed) */
  right: 10px;
  z-index: 1;
  background: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  padding: 5px;
  width: 29px;
  height: 29px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 0 2px rgba(0,0,0,.1);
}

.map-style-toggle img {
  width: 20px;
  height: 20px;
  display: block;
}

.map-style-toggle:hover {
  background-color: #f3f2f1;
}

.map-style-toggle:focus {
  outline: none !important;
  box-shadow: 0 0 0 2px rgba(0,0,0,.1) !important;
}

.map-style-toggle:focus-visible {
  outline: 3px solid #ffdd00 !important;
  outline-offset: 0;
  box-shadow: 0 0 0 2px #0b0c0c !important;
}
</style>
{% endblock %}